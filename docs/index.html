<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Guided Policy Search Codebase &mdash; GPS 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="GPS 0.1 documentation" href="#" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">
          GPS</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/cbfinn/gps">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Guided Policy Search</a><ul>
<li><a class="reference internal" href="#what-does-it-do">What Does It Do?</a></li>
<li><a class="reference internal" href="#installation">Installation</a><ul>
<li><a class="reference internal" href="#running-tests">Running tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#box2d-example">Box2D Example</a></li>
<li><a class="reference internal" href="#pr2-example">PR2 Example</a></li>
<li><a class="reference internal" href="#gui-target-setup">GUI & Target Setup Documentation</a></li>
<li><a class="reference internal" href="#controller-documentation">ROS PR2 Controller Documentation</a><ul>
<li><a class="reference internal" href="#adding-agent">Adding a robot agent</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reporting-bugs-and-getting-help">Reporting Bugs and Getting Help</a></li>
<li><a class="reference internal" href="#contributing">Contributing</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="computation-graph-toolkit">

<h1>Guided Policy Search Codebase<a class="headerlink" href="#computation-graph-toolkit" title="Permalink to this headline">¶</a></h1>
<p>This codebase implements the code of several research papers involving guided policy search. It includes a complete robot controller and sensor interface
for the PR2 robot via ROS, and an interface for simulated agents in Box2D and Mujoco.
Source code is available on <a class="reference external" href="https://github.com/cbfinn/gps">GitHub</a>.</p>

<div class="section" id="what-does-it-do">
<h2>What Does It Do?<a class="headerlink" href="#what-does-it-do" title="Permalink to this headline">¶</a></h2>
<p>The code is the base of several research papers:</p>
<ul class="simple">
<li>TODO</li>
</ul>
<p>Please cite the relevant paper(s) above and the following if the codebase helps your research:</p>
<ul class="simple">
<li>TODO</li>
</ul>
</div>

<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
See README on <a class="reference external" href="https://github.com/cbfinn/gps">GitHub</a>.
<!--p><strong>Dependencies</strong>:</p>
<p>Python backend requires:</p>
<ul class="simple">
<li>NumPy &gt;= 1.9</li>
</ul>
<p>Native (C++) backend requires:</p>
<ul class="simple">
<li>Cython &gt;= 0.22</li>
<li>A C++ compiler supporting C++11 (g++ &gt;= 4.7, or recent clang)</li>
</ul>
<p>GPU on native backend requires:</p>
<ul class="simple">
<li>CUDA Tookit</li>
</ul>
<div class="section" id="option-1-python-numpy-only">
<h3>Option 1: Python (NumPy) only<a class="headerlink" href="#option-1-python-numpy-only" title="Permalink to this headline">¶</a></h3>
<p>No compilation is required for this option, and NumPy is the only dependency.
Just update your <tt class="docutils literal"><span class="pre">PYTHONPATH</span></tt> as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>export PYTHONPATH=/path/to/cgt
</pre></div>
</div>
</div>
<div class="section" id="option-2-build-native-c-backend">
<h3>Option 3: Build C++ backend with CUDA<a class="headerlink" href="#option-3-build-c-backend-with-cuda" title="Permalink to this headline">¶</a></h3>
<p>Follow the instructions for Option 2, but alter the cmake command to instead read:</p>
<div class="highlight-python"><div class="highlight"><pre>cmake .. -DCGT_ENABLE_CUDA=ON
</pre></div>
</div>
</div>
<div class="section" id="option-4-vm-with-preinstalled-cgt-cuda">
<h3>Option 4: VM with preinstalled CGT + CUDA<a class="headerlink" href="#option-4-vm-with-preinstalled-cgt-cuda" title="Permalink to this headline">¶</a></h3>
<p>TODO</p>
</div>
<div class="section" id="running-unit-tests">
<h3>Running unit tests<a class="headerlink" href="#running-unit-tests" title="Permalink to this headline">¶</a></h3>
<p>You can run our suite of unit tests to verify your installation. In the source directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">nosetests</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
<p>Note that you&#8217;ll have to install the <tt class="docutils literal"><span class="pre">nose</span></tt> python module.</p>
</div>
</div-->

<div class="section" id="box2d-example">
<h2>Box2D Example<a class="headerlink" href="#box2d-example" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="pr2-example">
<h2>PR2 Example<a class="headerlink" href="#pr2-example" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="running-experiments">
<h2>Running Experiments<a class="headerlink" href="#running-experiments" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="gui-target-setup">
<h2>GUI & Target Setup Documentation<a class="headerlink" href="#gui-target-setup" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="controller-documentation">
<h2>ROS PR2 Controller Documentation<a class="headerlink" href="#controller-documentation" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="adding-agent">
<h2>Adding a robot agent<a class="headerlink" href="#adding-agent" title="Permalink to this headline">¶</a></h2>
</div>

<!--div class="ipynotebook">
<meta charset="utf-8" />
<title>tutorial_evaluated</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<style scoped="scoped" type="text/css">
    /*!
*//*!
*
/*# sourceMappingURL=style.min.css.map */
    </style>
<style scoped="scoped" type="text/css">
    .highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>


<style scoped="scoped" type="text/css">
/* Overrides of notebook CSS for static HTML export */

div#notebook {
  overflow: visible;
  border-top: none;
}

@media print {
  div.cell {
    display: block;
    page-break-inside: avoid;
  } 
  div.output_wrapper { 
    display: block;
    page-break-inside: avoid; 
  }
  div.output { 
    display: block;
    page-break-inside: avoid; 
  }
}
</style>

<!--
<style>
        div.output_text {
            margin:10px;
        }
        </style>

  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The basic workflow for using CGT is as follows.</p>
<p>1.) Define symbolic variables</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">import</span> <span class="nn">cgt</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="c"># float-valued scalar, with optional name provided</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int64&#39;</span><span class="p">)</span> <span class="c"># integer scalar</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>2.) Construct a expression out of these variables. Operators like <code>+,&lt;,**</code> are overloaded.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="n">n</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>3.) Construct a <code>function</code>, which maps numerical inputs to numerical outputs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
<span class="k">print</span> <span class="n">f</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>17.0
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In step 2, when you constructed the expression <code>c</code>, CGT was building up a data structure that stores the set of operations needed to compute <code>c</code> in terms of the input arguments. To be precise, CGT builds up a directed acyclic graph describing the dependencies.</p>

</div>
</div>
</div>




</div>

</div>
<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>L = Reshape(Sum{0}(square(((X × w + b) - y))))

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the first four lines, we created symbolic variables <code>X_nk, y_n, w_k, b</code>.
Then, we constructed more complex expressions by applying functions to these symbolic variables, finally giving us the loss function <code>L</code>.</p>
<p>You can find the available functions by inspecting at the <code>cgt</code> namespace (type <code>cgt.&lt;tab&gt;</code>), and you'll find lots of familiar NumPy functions. Note that these symbolic variables have some of the same attributes as NumPy arrays.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span> <span class="n">X_nk</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">X_nk</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">X_nk</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>2 [Result{Size{0}}, Result{Size{1}}] f4
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we can compute the gradient of the loss function with respect to the parameters $W,b$. (Note, however, that there's nothing special about parameters: we could just as well compute the gradient with respect to $X$ and $y$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">grads</span> <span class="o">=</span> <span class="n">dLdw</span><span class="p">,</span> <span class="n">dLdb</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">[</span><span class="n">w_k</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, <code>dLdw</code> and <code>dLdb</code> are just expressions. When we called <code>cgt.grad</code>, CGT walked through the graph that represents the expression <code>L</code> and constructed expressions for the gradients. This procedure is an variant of reverse-mode automatic differentiation or the backpropagation algorithm.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span> <span class="s">&quot;Loss and gradient objects&quot;</span><span class="p">,</span> <span class="n">dLdw</span><span class="p">,</span> <span class="n">dLdb</span>
<span class="k">print</span> <span class="s">&quot;Pretty-printed gradient: &quot;</span><span class="p">,</span> 
<span class="n">cgt</span><span class="o">.</span><span class="n">print_expr</span><span class="p">(</span><span class="n">cgt</span><span class="o">.</span><span class="n">simplify</span><span class="p">([</span><span class="n">dLdw</span><span class="p">])[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">cgt</span><span class="o">.</span><span class="n">as_dot</span><span class="p">(</span><span class="n">cgt</span><span class="o">.</span><span class="n">simplify</span><span class="p">([</span><span class="n">dLdw</span><span class="p">]))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Loss and gradient objects Result{Mul21} Result{Reshape}
Pretty-printed gradient: Xᵗ × (2 * ((X × w + b) - y))
</pre>
</div>
</div>

<div class="output_area">
</div>

</div>

<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we can compile functions to compute the loss and gradients.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">f_loss</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">X_nk</span><span class="p">,</span> <span class="n">y_n</span><span class="p">,</span> <span class="n">w_k</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">L</span><span class="p">)</span>
<span class="n">f_grads</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">X_nk</span><span class="p">,</span> <span class="n">y_n</span><span class="p">,</span> <span class="n">w_k</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">grads</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's generate some random numerical data and parameter values so we can test out these functions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">numpy.random</span> <span class="kn">as</span> <span class="nn">nr</span>
<span class="n">nr</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># Generate some random data</span>
<span class="n">Xval</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">yval</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="c"># Initialize parameters</span>
<span class="n">wval</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">bval</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;loss:&quot;</span><span class="p">,</span> <span class="n">f_loss</span><span class="p">(</span><span class="n">Xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">wval</span><span class="p">,</span> <span class="n">bval</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;grad:&quot;</span><span class="p">,</span> <span class="n">f_grads</span><span class="p">(</span><span class="n">Xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">wval</span><span class="p">,</span> <span class="n">bval</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>loss: 271.295806885
grad: [array([ -79.451, -194.393,  123.493], dtype=float32), array(55.82769012451172, dtype=float32)]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we can compute the gradient, we're ready to do some optimization, where we minimize the loss with respect to $W,b$. There are many different styles for doing numerical optimization with CGT.</p>
<p>We'll start with a style that is convenient but not the most efficient for large-scale machine learning. Namely, we'll flatten and concatenate the parameters into one vector $\theta$, and we'll return a flat gradient vector.
Then we'll hand off our functions to scipy's BFGS optimizer.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">f_loss</span><span class="p">(</span><span class="n">Xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">gradf</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">gw</span><span class="p">,</span><span class="n">gb</span> <span class="o">=</span> <span class="n">f_grads</span><span class="p">(</span><span class="n">Xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">gw</span><span class="p">,</span><span class="n">gb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">opt</span>
<span class="n">theta_opt</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fmin_bfgs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">gradf</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Optimal theta:&quot;</span><span class="p">,</span> <span class="n">theta_opt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Optimal theta: [-0.042 -0.051  0.041 -0.182]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's just make sure we got the right answer:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span> <span class="s">&quot;Least squares solution:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Xval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Xval</span><span class="p">),</span><span class="mi">1</span><span class="p">))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">yval</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Least squares solution: [-0.042 -0.051  0.041 -0.182]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can also do the flattening and unflattening using CGT, which will usually be faster:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">theta</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span>
<span class="n">w_k_1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">b_1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">ypred_n_1</span> <span class="o">=</span> <span class="n">X_nk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w_k_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_1</span>
<span class="n">L_1</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cgt</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ypred_n_1</span> <span class="o">-</span> <span class="n">y_n</span><span class="p">))</span>
<span class="n">dLdtheta</span><span class="p">,</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">L_1</span><span class="p">,</span> <span class="p">[</span><span class="n">theta</span><span class="p">])</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">theta</span><span class="p">],</span> <span class="n">L_1</span><span class="p">,</span> <span class="n">givens</span> <span class="o">=</span> <span class="p">[(</span><span class="n">X_nk</span><span class="p">,</span><span class="n">Xval</span><span class="p">),</span> <span class="p">(</span><span class="n">y_n</span><span class="p">,</span><span class="n">yval</span><span class="p">)])</span>
<span class="n">gradf</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">theta</span><span class="p">],</span> <span class="n">dLdtheta</span><span class="p">,</span> <span class="n">givens</span> <span class="o">=</span> <span class="p">[(</span><span class="n">X_nk</span><span class="p">,</span><span class="n">Xval</span><span class="p">),</span> <span class="p">(</span><span class="n">y_n</span><span class="p">,</span><span class="n">yval</span><span class="p">)])</span>

<span class="n">theta_opt</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">fmin_bfgs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">gradf</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Optimal theta:&quot;</span><span class="p">,</span> <span class="n">theta_opt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Optimal theta: [-0.042 -0.051  0.041 -0.182]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that we provided one additional argument to <code>cgt.function</code> above: <code>givens</code>. The value provided should be a list of pairs (input variable, replacement), where replacement can be a numerical value or some other symbolic variable.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll introduce another way of doing optimization, but here we will be able to do in-place updates of our parameters, which will be useful for large-scale problems. This style is especially useful when using the GPU, to avoid transfering data to and from the device.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">stepsize</span><span class="o">=</span><span class="mf">0.001</span>
<span class="n">w_k_2</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">wval</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
<span class="n">b_2</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">bval</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ypred_n_2</span> <span class="o">=</span> <span class="n">X_nk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w_k_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_2</span>
<span class="n">L_2</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cgt</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ypred_n_2</span> <span class="o">-</span> <span class="n">y_n</span><span class="p">))</span>
<span class="n">dLdw_2</span><span class="p">,</span><span class="n">dLdb_2</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">L_2</span><span class="p">,</span> <span class="p">[</span><span class="n">w_k_2</span><span class="p">,</span> <span class="n">b_2</span><span class="p">])</span>

<span class="n">updates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">w_k_2</span><span class="p">,</span> <span class="n">w_k_2</span> <span class="o">-</span> <span class="n">stepsize</span><span class="o">*</span><span class="n">dLdw_2</span><span class="p">),</span> <span class="p">(</span><span class="n">b_2</span><span class="p">,</span> <span class="n">b_2</span> <span class="o">-</span> <span class="n">stepsize</span><span class="o">*</span><span class="n">dLdb_2</span><span class="p">)]</span>
<span class="n">givens</span> <span class="o">=</span>  <span class="p">[(</span><span class="n">X_nk</span><span class="p">,</span><span class="n">Xval</span><span class="p">),</span> <span class="p">(</span><span class="n">y_n</span><span class="p">,</span><span class="n">yval</span><span class="p">)]</span>
<span class="n">f_update</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([],</span> <span class="n">L_2</span><span class="p">,</span> <span class="n">givens</span> <span class="o">=</span> <span class="n">givens</span><span class="p">,</span> <span class="n">updates</span> <span class="o">=</span> <span class="n">updates</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">f_update</span><span class="p">()</span>
<span class="k">print</span> <span class="n">w_k_2</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span> <span class="n">b_2</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[-0.042 -0.051  0.041] -0.182046338916
</pre>
</div>
</div>

</div>
</div>

</div>
    </div>
  </div>

</div><p>(<a class="reference external" href="tutorial.ipynb">tutorial.ipynb</a>; <a class="reference external" href="tutorial_evaluated.ipynb">tutorial_evaluated.ipynb</a>; <a class="reference external" href="tutorial.py">tutorial.py</a>)</p>
</div>

<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>CGT uses a some global configuration options that you should be aware of.
You can set these options in the file <tt class="docutils literal"><span class="pre">~/.cgtrc</span></tt>; see <tt class="docutils literal"><span class="pre">cgtrc.example</span></tt> in the source directory for a template.
You can also modify these values via the command line, e.g. <tt class="docutils literal"><span class="pre">CGT_FLAGS=backend=native,precision=double</span></tt>.
The file, <tt class="docutils literal"><span class="pre">cgtrc_spec.ini</span></tt>, included below, provides a listing of the configuration variables.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># At the cost of some overhead,</span>
<span class="c"># store information in the computation graph that helps with debugging</span>
<span class="n">debug</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># single or double precision:</span>
<span class="n">precision</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">single</span><span class="p">)</span> 

<span class="c"># backend=python means using a pure python module to execute the graph, and using python implementations of ops whenever they exist</span>
<span class="c"># backend=native means using the compiled execution graph interpreter, and using the native (c++) implementation of ops</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">option</span><span class="p">(</span><span class="s">&quot;python&quot;</span><span class="p">,</span><span class="s">&quot;native&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s">&quot;python&quot;</span><span class="p">)</span> <span class="c"># &quot;native&quot; means using compiled implementations and </span>

<span class="c"># Where to put generated files</span>
<span class="n">cache_dir</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&quot;~/.cgt_cache&quot;</span><span class="p">)</span>

<span class="c"># Enable in-place optimizations.</span>
<span class="n">enable_inplace_opt</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Enable simplifications of the graph, e.g. arithmetic simplifications like x*1=x</span>
<span class="n">enable_simplification</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Use parallel execution graph interpreter</span>
<span class="n">parallel</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Number of </span>
<span class="n">num_threads</span> <span class="o">=</span> <span class="n">integer</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c"># Developer Options</span>
<span class="c"># -----------------</span>

<span class="c"># Force native backend to use python</span>
<span class="n">force_python_impl</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Compile C++ files with debug flags</span>
<span class="n">debug_cpp</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c"># use debug flags when compiling c++</span>

<span class="c"># Print lots of diagnostic information</span>
<span class="c"># (we&#39;ll break this down at some point)</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>For best performance, set <tt class="docutils literal"><span class="pre">backend=native,</span> <span class="pre">but</span> <span class="pre">for</span> <span class="pre">development</span> <span class="pre">you</span> <span class="pre">should</span> <span class="pre">set</span> <span class="pre">``backend=python</span></tt> because the error handling is better.</p>
</div>
<div class="section" id="guide-to-porting-theano-code-to-cgt">
<h2>Guide to Porting Theano Code to CGT<a class="headerlink" href="#guide-to-porting-theano-code-to-cgt" title="Permalink to this headline">¶</a></h2>
<p>CGT mostly replicates Theano&#8217;s API, but there are a few gotchas.</p>
<ul>
<li><p class="first">CGT does not allow automatic broadcasting of singleton dimensions (for elementwise binary operations like addition and multiplication.) Use the <tt class="docutils literal"><span class="pre">broadcast</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bcpat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform elementwise binary operation such as addition or multiplication, and expand</span>
<span class="sd">    singleton dimensions when appropriate.</span>

<span class="sd">    opname: string name of operation: *,+,-,/,&lt;,&gt;,&lt;=,&gt;=,**,==,!=</span>
<span class="sd">    a, b: variables</span>
<span class="sd">    bcpat: a string of x,1 specifying which dimensions are singletons in both a and b. Here are some examples:</span>
<span class="sd">        &quot;x1,1x&quot;:        a.shape[1] == 1 and b.shape[0] == 1</span>
<span class="sd">        &quot;xx1,xxx&quot;:      a.shape[2] == 1, but we should have a.shape[0]==b.shape[0] and a.shape[1]==b.shape[1]</span>

<span class="sd">    E.g., here&#39;s an example of using this function</span>
<span class="sd">    a = np.zeros((2,3))</span>
<span class="sd">    b = np.zeros((2,1))</span>
<span class="sd">    z = cgt.broadcast(&quot;+&quot;, a, b, &quot;xx,x1&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</div>

<div class="section" id="nn-neural-network-module">
<h2>nn: Neural Network Module<a class="headerlink" href="#nn-neural-network-module" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">nn</span></tt> module (<tt class="docutils literal"><span class="pre">import</span> <span class="pre">cgt.nn</span></tt>) provides a light wrapper around CGT&#8217;s core API that allows the user to concisely build up complicated neural network models.
Below we will show how to build up a convolutional neural network, and then how to parallelize it using the multi-threaded interpreter.
A complete code listing can be found in <tt class="docutils literal"><span class="pre">examples/cgt_theano_feedforward_comparison.py</span></tt>.</p>

<div class="section" id="a-simple-convnet">
<h3>A Simple ConvNet<a class="headerlink" href="#a-simple-convnet" title="Permalink to this headline">¶</a></h3>
<p>The following code constructs a simple convolution neural network (sized for MNIST images, what else?),
where the loss function is the negative log-likelihood of labels.
(A full listing is provided in the source directory, see <tt class="docutils literal"><span class="pre">examples/cgt_theano_feedforward_comparison.py</span></tt>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># X: a symbolic variable representing a batch of input images,</span>
<span class="c"># with shape (batchsize, nchannels, nrows, ncols)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">tensor4</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="n">fixed_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
<span class="c"># We provide the fixed_shape argument so</span>
<span class="c"># CGT can infer the shape of downstream variables</span>
<span class="c"># y: a symbolic variable representing the labels, which are integers</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;i8&#39;</span><span class="p">)</span>
<span class="c"># SpatialConvolution(...) is a constructor call, which builds the weights</span>
<span class="c"># (filter) and the biases for the convolutional layer</span>
<span class="c"># rectify(...) is just a function call that maps x -&gt; x*(x&gt;0)</span>
<span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">rectify</span><span class="p">(</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">SpatialConvolution</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernelshape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">weight_init</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">IIDGaussian</span><span class="p">(</span><span class="n">std</span><span class="o">=.</span><span class="mi">1</span><span class="p">))(</span><span class="n">X</span><span class="p">))</span>
<span class="c"># Apply max pooling function</span>
<span class="n">pool1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">max_pool_2d</span><span class="p">(</span><span class="n">conv1</span><span class="p">,</span> <span class="n">kernelshape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="c"># Another convolutional layer</span>
<span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">rectify</span><span class="p">(</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">SpatialConvolution</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernelshape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">weight_init</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">IIDGaussian</span><span class="p">(</span><span class="n">std</span><span class="o">=.</span><span class="mi">1</span><span class="p">))(</span><span class="n">pool1</span><span class="p">))</span>
<span class="n">pool2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">max_pool_2d</span><span class="p">(</span><span class="n">conv2</span><span class="p">,</span> <span class="n">kernelshape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="c"># Now we flatten the last output image</span>
<span class="n">d0</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span> <span class="o">=</span> <span class="n">pool2</span><span class="o">.</span><span class="n">shape</span>
<span class="n">flatlayer</span> <span class="o">=</span> <span class="n">pool2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">d0</span><span class="p">,</span><span class="n">d1</span><span class="o">*</span><span class="n">d2</span><span class="o">*</span><span class="n">d3</span><span class="p">])</span>
<span class="c"># CGT can infer the shape of variables</span>
<span class="n">nfeats</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">infer_shape</span><span class="p">(</span><span class="n">flatlayer</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="c"># One final fully-connected layer, and then a log-softmax</span>
<span class="n">logprobs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">logsoftmax</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Affine</span><span class="p">(</span><span class="n">nfeats</span><span class="p">,</span> <span class="mi">10</span><span class="p">)(</span><span class="n">flatlayer</span><span class="p">))</span>
<span class="n">neglogliks</span> <span class="o">=</span> <span class="o">-</span><span class="n">logprobs</span><span class="p">[</span><span class="n">cgt</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">neglogliks</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>Now that we&#8217;ve built up an expression for the loss, we can build an expression for the gradient</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># walk through the graph and find all parameters</span>
<span class="c"># i.e., variables constructed with cgt.shared(...)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="n">gparams</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can build up a function that updates the parameters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">updates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="n">stepsize</span><span class="o">*</span><span class="n">gp</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">gp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">gparams</span><span class="p">)]</span>
<span class="n">updater</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">],</span> <span class="n">loss</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div class="section" id="adding-parallelization">
<h3>Adding parallelization<a class="headerlink" href="#adding-parallelization" title="Permalink to this headline">¶</a></h3>

<p>CGT is capable of executing computations in parallel.
A feedforward network does not offer much opportunity for parallelization, but we can easily transform it to use data parallelism.</p>
<p>First let&#8217;s build a <tt class="docutils literal"><span class="pre">Module</span></tt>, which is a parameterized function.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">loss</span><span class="p">])</span>
</pre></div>
</div>
<p>The two arguments to the <cite>Module</cite> constructor are a list of inputs and a list of outputs, respectively.</p>
<p>Now, we can split the data along the zeroth apply the module <cite>m</cite> separately to each piece.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">split_loss</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">//</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">sli</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span><span class="o">+</span><span class="n">batch_size</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">split_loss</span> <span class="o">+=</span> <span class="n">m</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">sli</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">sli</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">split_loss</span> <span class="o">/=</span> <span class="mi">4</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="n">split_loss</span><span class="p">)</span>
<span class="n">gparams</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">split_loss</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">updates2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="n">stepsize</span><span class="o">*</span><span class="n">gp</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">gp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">gparams</span><span class="p">)]</span>
<span class="n">updater</span> <span class="o">=</span>  <span class="n">cgt</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">],</span> <span class="n">split_loss</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>

<p>Let&#8217;s suppose you have compiled a <tt class="docutils literal"><span class="pre">function</span></tt>, but it is failing at runtime or returning invalid results, and you&#8217;re trying to figure out what might be wrong.
Here are some steps you can take:</p>
<ol class="arabic">
<li><p class="first">Use the python backend. That is, modify <tt class="docutils literal"><span class="pre">.cgtrc</span></tt> or set <tt class="docutils literal"><span class="pre">CGT_FLAGS=backend=python</span></tt> at the command line. The python implementation of operations use numpy, which may catch certain errors (e.g. shape mismatches) that our C++ implementations miss.</p>
</li>
<li><p class="first">Set the configuration variable <tt class="docutils literal"><span class="pre">debug=True</span></tt> (with <tt class="docutils literal"><span class="pre">.cgtrc</span></tt> or <tt class="docutils literal"><span class="pre">CGT_FLAGS</span></tt>.) That will enable several pieces of functionality that store information in the graph when you are building it, so useful information can be printed when an exception is reached.</p>
</li>
<li><p class="first">If there is a shape error, you can sometimes find it by using the <tt class="docutils literal"><span class="pre">infer_shape</span></tt> function. When constructing your variables, specify the known components of their shapes, e.g. Then you can add assertions with <tt class="docutils literal"><span class="pre">infer_shape</span></tt> (We plan to add more functionality soon that will catch shape errors at graph construction time.) Here&#8217;s an example:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">fixed_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cgt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">fixed_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">cgt</span><span class="o">.</span><span class="n">infer_shape</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<p>You can also take this a step further and compute numerical values associated with the nodes in the graph. Just replace <tt class="docutils literal"><span class="pre">x</span></tt> and <tt class="docutils literal"><span class="pre">y</span></tt> above with constants, and then use <tt class="docutils literal"><span class="pre">cgt.simplify</span></tt> to compute the value of <tt class="docutils literal"><span class="pre">z</span></tt>.</p>
<ol class="arabic simple" start="4">
<li><em>Disable optimizations.</em> Set <tt class="docutils literal"><span class="pre">enable_simplification=False</span></tt> and <tt class="docutils literal"><span class="pre">enable_inplace_opt=False</span></tt> in <tt class="docutils literal"><span class="pre">.cgtrc</span></tt>. Maybe there is a bug in cgt&#8217;s optimization. If so, please <a class="reference internal" href="#bugshelp"><em>report it</em></a>.</li>
</ol>
</div>

<div class="section" id="cookbook">
<h2>Cookbook<a class="headerlink" href="#cookbook" title="Permalink to this headline">¶</a></h2>

<p>See <tt class="docutils literal"><span class="pre">examples</span></tt> directory:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">demo_mnist.py</span></tt>: shows how to build up a fully-connected or convolutional neural network  using a low-level API.</li>
<li><tt class="docutils literal"><span class="pre">demo_cifar.py</span></tt>: train a convolutional neural net on CIFAR dataset using <tt class="docutils literal"><span class="pre">nn</span></tt>&#8216;s Torch-like API.</li>
<li><tt class="docutils literal"><span class="pre">demo_char_rnn.py</span></tt>: based on Andrej Karpathy&#8217;s char-rnn code, but all in one file for building the deep LSTM or GRU model and generating text.</li>
<li><tt class="docutils literal"><span class="pre">demo_neural_turing_machine.py</span></tt>: implementation of the <a class="reference external" href="http://arxiv.org/abs/1410.5401">Neural Turing Machine</a>, with feedforward controller.</li>
</ul>
<p>More examples are coming soon!</p>
</div-->

<div class="section" id="reporting-bugs-and-getting-help">
<span id="bugshelp"></span><h2>Reporting Bugs and Getting Help<a class="headerlink" href="#reporting-bugs-and-getting-help" title="Permalink to this headline">¶</a></h2>

<p>You can post your queries on the <a class="reference external" href="https://groups.google.com/forum/#!forum/cgt-users">cgt-users discussion group</a>.
If you want to participate in the development of CGT, post on the <a class="reference external" href="https://groups.google.com/forum/#!forum/cgt-devel">cgt-devel discussion group</a>.</p>
</div>

<div class="section" id="contributing">
<span id="contributing"></span><h2>Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h2>

<p>Make a pull request on Github.</p>

</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>
